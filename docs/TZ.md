# ChatriX — Техническое задание

Версия: 1.0 (финальная редакция)
Дата: 2026‑01‑18

## 1) Назначение и цели
**ChatriX** — мобильное приложение и серверная платформа, объединяющая сильные AI‑инструменты для общения, творчества, работы и обучения.

Ключевые качества:
- кроссплатформенность (Android first, iOS‑ready);
- интерактивность, адаптивность и премиальный визуальный стиль;
- высокая плавность UI и стабильность;
- модульность: новые модели/провайдеры/функции подключаются без переработки ядра;
- строгие лимиты и доступ по тарифам.

## 2) Платформы и архитектура
### 2.1 Клиент
- Платформы: Android (первый релиз), затем iOS.
- Реализация: кроссплатформенный фреймворк (рекомендуемо Flutter). Конкретный выбор фиксируется в `docs/DECISIONS.md`.
- UI: дизайн‑система (цвета/типографика/отступы/компоненты), анимации переходов, адаптивная верстка.

### 2.2 Сервер
- Python + современный API‑фреймворк (рекомендуемо FastAPI).
- База данных: PostgreSQL.
- Фоновые задачи: обязательны (обработка медиа, сборки проектов, конвертации).
- Хранилище файлов: S3‑совместимое объектное хранилище (dev: MinIO), метаданные в PostgreSQL.
- AI‑оркестратор: единый интерфейс провайдеров и policy‑engine (лимиты/права/стоимость).

### 2.3 Расширяемость под DevOps
Система должна иметь готовые точки расширения (без обязательного внедрения на MVP): CI/CD, мониторинг, резервное копирование, масштабирование воркеров.

## 3) Роли и права
- **User** — обычный пользователь.
- **VIP • SIGNATURE** — максимальные лимиты и доступ к лучшим настройкам.
- **DEVELOPER • GATE** — доступ к расширенным возможностям после KYC, включая платный Dev‑Container в разделе «Работа».

## 4) Авторизация и привязки аккаунтов
Обязательная авторизация. Поддерживаемые провайдеры:
- Google
- Apple
- Yandex
- Telegram
- Discord
- TikTok

Требования:
- один пользователь может привязать несколько провайдеров;
- хранить только необходимые идентификаторы и токены (секреты в безопасном хранилище на клиенте, на сервере — защищённо);
- для условий реферальной программы у реферала должно быть **минимум 2** привязки провайдеров.

## 5) Баланс, пополнение и конвертация валют
### 5.1 Внутренний баланс
- Валюта баланса: **RUB**.
- Хранение: в копейках (целое число), через внутренний ledger (журнал операций) с идемпотентностью.

### 5.2 Способы пополнения
- Google Pay
- Apple Pay
- ЮMoney

### 5.3 Конвертация, если платёж в USD/другой валюте
Баланс пополняется в RUB.

Формула:
- `RUB = round2(amount_fx * CBR_rate(fx, rate_date) * 1.05)`
- округление до 2 знаков, затем перевод в копейки.
- курс ЦБ обновляется **1 раз в день** и сохраняется в БД.

БД:
- таблица `fx_rates(rate_date, ccy, rate_to_rub, fetched_at, source='CBR')`.

Платёжная запись обязана фиксировать:
- валюту и сумму исходного платежа,
- курс ЦБ, дату курса,
- наценку 5%,
- итог в RUB.

## 6) Тарифы (12 уровней)
### 6.1 Таблица тарифов
| Код | Название | Период | Цена |
|---|---|---:|---:|
| ZERO | Zero | — | бесплатно |
| CORE | Core | 1 месяц | 150 ₽ |
| START | Start | 3 месяца | 500 ₽ |
| PRIME | Prime | 3 месяца | 800 ₽ |
| ADVANCED | Advanced | 3 месяца | 1100 ₽ |
| STUDIO | Studio | 3 месяца | 1400 ₽ |
| BUSINESS | Business | 3 месяца | 2000 ₽ |
| BLD_DIALOGUE | Builder • Dialogue | 3 месяца | от 700 ₽ |
| BLD_MEDIA | Builder • Media | 3 месяца | от 700 ₽ |
| BLD_DOCS | Builder • Docs | 3 месяца | от 700 ₽ |
| VIP | VIP • Signature | единоразово | 15000 ₽ |
| DEV | Developer • Gate | 1 год | 5000 ₽ |

Примечания:
- **Zero** назначается при регистрации по умолчанию.
- **Zero не участвует в реферальной программе** (ссылка не отображается, приглашать нельзя).
- лимиты/права по тарифам задаются конфигурацией (таблицы `plan_limits`, `plan_entitlements`).

### 6.2 Конструкторы (Builder) — 3 типа
Конструкторы позволяют собрать тариф под задачу из модулей.

**База Builder (обязательная): 700 ₽ / 3 месяца**.

Итоговая цена:
- `Price_3m = 700 + Σ(module_prices_3m) + Σ(storage_packs_3m) + Σ(section_fees_3m) + Σ(devbox_addons_3m)`

Годовая цена:
- `Price_12m = round(Price_3m * 4 * 0.85)` (скидка 15% за год). Значение скидки хранить конфигом.

#### 6.2.1 Builder • Dialogue (текст + аудио)
| Модуль | Описание | Цена / 3 мес |
|---|---|---:|
| CHAT_CORE | Текстовый чат: темы, история, базовая инструкция | 300 ₽ |
| AUDIO_STT_TTS | Аудио (STT+TTS) запрос‑ответ | 500 ₽ |
| AUDIO_LIVE | Live‑аудиосессии (низкая задержка, сессии) | 900 ₽ |
| CUSTOM_VOICES | Загрузка/создание голосов | 1200 ₽ |

#### 6.2.2 Builder • Media (текст + аудио + фото + видео)
| Модуль | Описание | Цена / 3 мес |
|---|---|---:|
| IMAGE_AI_PRO | Генерация/редактирование изображений (Pro) | 700 ₽ |
| VIDEO_AI_PRO | Генерация/улучшение видео (Pro) | 1400 ₽ |
| AVATAR_PHOTO_TALK | «Оживление» фото + голос | 900 ₽ |
| AVATAR_VIDEO_TALK | Общение на основе небольшого видео | 1400 ₽ |
| HQ_PACK | Пакет качества/скорости/HD‑режимы | 900 ₽ |

#### 6.2.3 Builder • Docs (документы и файлы)
Builder • Docs включает анализ документов и файлов, а также мультимодальные операции (текст/аудио/изображения/видео).

| Модуль | Описание | Цена / 3 мес |
|---|---|---:|
| DOC_READER_CORE | Парсинг и извлечение текста/структуры | 900 ₽ |
| TABLE_INTELLIGENCE | Таблицы/книги: csv/xls/xlsx и т.п. | 900 ₽ |
| OCR_PACK | OCR/скан‑извлечение (при необходимости) | 1400 ₽ |
| DB_SQL_INSIGHT | Анализ db/sql/log/config | 700 ₽ |

#### 6.2.4 Хранилище (доп. пакеты)
База: 100MB. Расширение зависит от тарифа и докупок.

| Пакет | Цена / 3 мес |
|---|---:|
| +1 GB | 150 ₽ |
| +5 GB | 600 ₽ |
| +10 GB | 1000 ₽ |

## 7) Реферальная программа
### 7.1 Общие правила
- Глубина дерева: технически может быть больше, но **выплаты только до 25 уровня**.
- Условия начисления:
  1) реферал оплатил тариф или сменил тариф на платный;
  2) у реферала привязано минимум 2 провайдера входа;
  3) начисление выполняется идемпотентно.
- Формула:
  `reward = paid_amount_rub * percent(level, inviter_plan) / 100`

### 7.2 Отображение
- **Zero**: реферальная ссылка не показывается, приглашать нельзя.
- Платные тарифы: ссылка показывается, пользователь может приглашать.

### 7.3 Таблица процентов (L1..L25)
Формат: значения в процентах для уровней 1..25.

**ZERO (Zero):** не участвует в реферальной программе.

**CORE (Core):**
3,2.7,2.4,2.1,1.8,1.6,1.4,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.45,0.4,0.35,0.3,0.25,0.2,0.18,0.16,0.14,0.12,0.10

**START (Start):**
5,4.5,4,3.6,3.2,2.8,2.4,2.0,1.8,1.6,1.4,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.25,0.2,0.15,0.12,0.10

**PRIME (Prime):**
5.5,5.0,4.5,4.0,3.5,3.1,2.7,2.3,2.0,1.8,1.6,1.4,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.22,0.16,0.12,0.10

**ADVANCED (Advanced):**
6,5.5,5,4.5,4,3.5,3,2.7,2.4,2.1,1.8,1.5,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**STUDIO (Studio):**
7,6,5.5,5,4.5,4,3.5,3,2.5,2.2,2.0,1.6,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**BUSINESS (Business):**
8,7,6,5.5,5,4.5,4,3.5,3,2.5,2,1.5,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**BLD_DIALOGUE (Builder • Dialogue):**
5.8,5.2,4.6,4.0,3.6,3.2,2.8,2.4,2.1,1.9,1.7,1.5,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**BLD_MEDIA (Builder • Media):**
7.5,7.0,6.0,5.5,5.0,4.5,4.0,3.5,3.0,2.5,2.0,1.5,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**BLD_DOCS (Builder • Docs):**
6.5,6.0,5.5,5.0,4.5,4.0,3.5,3.0,2.6,2.2,2.0,1.6,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**DEV (Developer • Gate):**
10,9,8,7,6,5,4,3.5,3,2.5,2,1.5,1.2,1.0,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.15,0.12,0.10

**VIP (VIP • Signature):**
12,11,10,9,8,7,6,5,4,3,2,1,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.09,0.08,0.07,0.06,0.05

## 8) Функциональные экраны приложения
### 8.1 Общие
- Главная навигация по разделам.
- Профиль: привязка аккаунтов, тариф, лимиты, хранилище.
- Настройки: общие и расширенные (по тарифу).
- Поддержка: FAQ/правила/инструкции.

### 8.2 Chat (текст)
- чаты по темам;
- промт‑инструкция на чат (ограничение по тарифу);
- история, поиск, экспорт (по тарифу);
- AI‑оркестратор на сервере (выбор провайдера/модели/инструментов).

### 8.3 Voice (аудио)
- базовые и live‑режимы;
- стартовые голоса и кастомные (по тарифу);
- ограничения по длительности/количеству/качеству.

### 8.4 Video (видеообщение и аватар)
- Zero: демо 10 секунд;
- расширенные планы: живое общение на основе загруженного фото/видео;
- список видео‑чатов: имя, фото/видео, голос, настройки и промт.

### 8.5 Tools
- Audio tools, Image AI, Video AI — набор функций зависит от тарифа.

### 8.6 Docs (документы)
- загрузка файлов, извлечение текста/структуры, анализ и генерация выводов;
- поддерживаемые типы — см. раздел 12.

### 8.7 Hobby / Study / Work
Экраны формируются из подготовленных UI‑элементов.

**Разделы внутри экранов создаются по требованию пользователя**:
- 3 раздела бесплатно (суммарно на Hobby+Study+Work);
- каждый следующий раздел: **300 ₽ / 3 месяца**;
- для создания раздела требуется заполнить бриф (см. `docs/SECTION_BRIEF_TEMPLATE.md`);
- созданный раздел — это UX + AI‑workflow, использующий API ИИ как функциональный движок.

**Work**:
- доступен в полном объёме только для старших тарифов согласно конфигу;
- для Developer доступен платный Dev‑Container (см. раздел 11).

## 9) Политики лимитов и прав (policy engine)
Все ограничения должны быть реализованы на сервере как обязательная проверка:
- лимиты по времени/количеству/размеру/качеству;
- доступ к настройкам;
- доступ к моделям/провайдерам;
- квоты хранилища;
- ограничения на промт‑инструкции и инструменты.

Реализация: таблицы `plan_limits`/`plan_entitlements` + сервис проверки.

## 10) Журнал операций (ledger)
- все операции с балансом: только через ledger;
- идемпотентность (`Idempotency-Key`);
- аудит (кто/что/когда/почему);
- расчёт доступного баланса на основе записей.

## 11) Developer Dev‑Container (платно)
Для пользователей **DEVELOPER • GATE** в разделе Work доступна возможность открыть контейнер для разработки и выбрать стек.

Требования:
- выбор готового стека в контейнере (например: Node, Python, Go и т.п.); список стеков задаётся конфигом;
- ограничения ресурсов (CPU/RAM/DISK/egress);
- безопасная изоляция;
- оплата как add‑on.

Ценообразование:
- хранить тарифы инфраструктуры в БД: `infra_rates(cpu_core_hour_rub, ram_gb_hour_rub, disk_gb_month_rub, egress_gb_rub, platform_fee_rub, margin_percent)`.
- формула:
  `DevBoxPrice = platform_fee + (cores*cpu_rate + ram_gb*ram_rate)*hours + disk_gb*disk_month_part + egress_gb*egress_rate`.

Рекомендованные пакеты (по умолчанию, редактируемые конфигом):
- DevBox S (1 vCPU / 2GB / 10GB) — 900 ₽ / 30 дней
- DevBox M (2 vCPU / 4GB / 30GB) — 1900 ₽ / 30 дней
- DevBox L (4 vCPU / 8GB / 80GB) — 3900 ₽ / 30 дней
- Stack Pack: +300 ₽ / 30 дней за каждый доп. стек сверх 1 базового.

## 12) Поддерживаемые форматы файлов (Docs)
White‑list расширений:
- txt, doc, docx, xls, xlsx, md, pdf, rtf, db, sql, epub, csv, mobi, odt, ott, sxw, for, ods, xlsm, xlsb, xml, log, ini, conf, pages, numbers, azw, azw3, fb2, djvu, cbr, cbz, ibooks.

## 13) Нефункциональные требования
- Производительность: быстрый старт, плавные анимации, разумное кеширование.
- Надёжность: устойчивость к плохой сети, повторяемые операции (идемпотентность).
- Безопасность: RBAC, rate limiting, безопасное хранение токенов, аудит.
- Приватность: минимизация персональных данных, политика хранения и удаления.

## 14) Артефакты результата
- Репозиторий (mobile + backend) с воспроизводимым запуском.
- Документация: запуск, конфиги, API контракты.
- Миграции БД.
- Тесты (unit + интеграционные по ключевым модулям).

## 15) Приложения
- Шаблон брифа на раздел: `docs/SECTION_BRIEF_TEMPLATE.md`
- Боевой промт для Codex: `docs/CODEX_PROMPT.md`
- Инструкция работы Codex по репозиторию: `docs/CODEX_RUNBOOK.md`
