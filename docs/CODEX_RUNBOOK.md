# ChatriX — Runbook управления Codex (операторская инструкция)

Этот runbook предназначен **вам** (человеку), чтобы заставить ChatGPT Codex работать по репозиторию **долго, аккуратно и без пропусков**, постоянно прогоняя тесты и сразу исправляя ошибки.

## 0) Главная идея
Codex должен работать только по циклу:

**Выбрал следующий пункт плана → реализовал → добавил/обновил тесты → прогнал CI → исправил ошибки → обновил доки → коммит.**

Ни одного шага “дальше”, если CI красный.

---

## 1) Как стартовать Codex (3 сообщения)
### Сообщение 1 (обязательное)
Вставьте Codex **полный текст** файла:
- `docs/CODEX_PROMPT.md`

И добавьте одну строку:
> “Следуй этому документу буквально. Начни с `codex/WORK_PLAN.md`: приведи статусы в соответствие реальному состоянию repo и добавь/почини CI-скрипты. Никаких заглушек без маркировки STUB и задач на замену.”

### Сообщение 2 (контекст требований)
Если Codex просит требования — вставьте:
- `docs/TZ.md`

### Сообщение 3 (план)
Вставьте:
- `codex/WORK_PLAN.md`

---

## 2) Как ставить задачи (правильный формат)
Задача всегда должна быть:
- **однозначной**, 
- **проверяемой**, 
- с требованием **tests + ci output**.

Примеры правильных задач:
1) “Выполни следующий невыполненный пункт из `codex/WORK_PLAN.md`. Обязателен `./scripts/ci.sh` и вывод результата. Если красно — чини до зелёного. Затем обнови `codex/WORK_PLAN.md`.”
2) “Сделай mobile foundation: создай полноценный Flutter scaffold, добавь Riverpod+go_router+dio, создай дизайн‑систему tokens и 1 экран Login с skeleton/error/empty state. Добавь 1 widget test и 1 golden test. Прогони CI.”
3) “Заменить STUB в OAuth Google на реальный flow (только backend adapter), добавить contract tests (mock provider) и обновить docs/DECISIONS.md. Прогони CI.”

Запрещённые формулировки:
- “сделай красиво” без критериев;
- “попробуй”;
- “потом добавим тесты”.

---

## 3) Что требовать от Codex после каждого шага
После каждого шага требуйте строго этот отчёт (в одном сообщении):
1) **Изменённые файлы** (список путей)
2) **Команды**, которые он запускал
3) **Вывод CI** (кратко, но с кодом возврата/итогом)
4) **Статус WORK_PLAN** (что стало ✅ и почему)

Если Codex не показывает вывод тестов — отвечайте:
> “Недостаточно. Запусти `./scripts/ci.sh` и дай результат. Если ошибки — исправь и повтори.”

---

## 4) Управление “беспрерывной” работой
Codex может “останавливаться” после одного шага. Чтобы продолжил:
- Всегда отвечайте: 
> “Продолжай со следующим невыполненным пунктом плана. Не переходи, пока CI не зелёный. Покажи изменённые файлы и вывод тестов.”

Если Codex начинает задавать вопросы, на которые можно выбрать дефолт:
- Ответ:
> “Выбирай разумный дефолт, но запиши допущение в `docs/DECISIONS.md` и продолжай.”

---

## 5) Если Codex уводит в сторону
Типовые проблемы и ответы:

### 5.1 “Я сделал заглушку, потом допишем”
Ответ:
> “Либо сделай полноценную реализацию, либо пометь STUB в коде и документации и добавь отдельный пункт WORK_PLAN ‘REPLACE STUB WITH REAL’. Тесты обязательны.”

### 5.2 “Слишком большой объём, давай без тестов”
Ответ:
> “Нельзя. После каждого пункта — тесты и CI. Уменьши шаг до 3–7 подпунктов, но тесты и CI обязательны.”

### 5.3 “Я изменил архитектуру без фиксации”
Ответ:
> “Зафиксируй в `docs/ARCHITECTURE.md` и `docs/DECISIONS.md`, затем повтори CI.”

---

## 6) Что считается “красиво” (операционные критерии)
Чтобы Codex не спорил о вкусе, используйте критерии:
- дизайн‑система tokens + компоненты
- одинаковые отступы/радиусы/типографика
- micro‑motion (анимация появления карточек/переходов)
- empty/error/loading states везде
- golden‑tests для ключевых экранов

---

## 7) Мини‑чеклист выпуска APK (Android)
Команды, которые Codex обязан держать зелёными:
- `./scripts/test_backend.sh`
- `./scripts/test_mobile.sh`
- `./scripts/build_apk_docker.sh`

Итоговый артефакт:
- `mobile/build/app/outputs/flutter-apk/app-release.apk`

